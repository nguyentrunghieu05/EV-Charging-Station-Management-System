<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVCS - Qu√©t m√£ b·∫Øt ƒë·∫ßu s·∫°c</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa}
        .navbar{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center}
        .container{max-width:800px;margin:30px auto;padding:0 20px}
        .card{background:#fff;padding:30px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px;text-align:center}
        .card h2{margin-bottom:20px;color:#333}
        .scan-section{display:flex;flex-direction:column;align-items:center;gap:20px}
        .qr-placeholder{width:250px;height:250px;border:2px dashed #667eea;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#f8f9ff;margin:20px 0}
        .qr-placeholder .icon{font-size:48px;color:#667eea}
        .input-group{width:100%;max-width:400px;margin:20px 0}
        .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#333}
        .input-group input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;transition:border-color 0.3s}
        .input-group input:focus{outline:none;border-color:#667eea}
        .btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s;margin:10px}
        .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
        .btn-secondary{background:#f0f0f0;color:#666}
        .btn-secondary:hover{background:#e0e0e0}
        .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
        .alert{padding:15px;border-radius:8px;margin:15px 0;text-align:left}
        .alert.success{background:#e8f5e9;color:#2e7d32}
        .alert.error{background:#ffebee;color:#c62828}
        .alert.info{background:#e3f2fd;color:#1565c0}
        .divider{margin:30px 0;height:1px;background:#eee;position:relative}
        .divider::before{content:'HO·∫∂C';position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:#fff;padding:0 15px;color:#666;font-size:14px}
        .session-info{background:#f8f9ff;padding:20px;border-radius:8px;margin:20px 0;text-align:left}
        .session-info h3{margin-bottom:15px;color:#667eea}
        .info-row{display:flex;justify-content:space-between;margin:8px 0;padding:5px 0;border-bottom:1px solid #eee}
        .info-row:last-child{border-bottom:none}
        .loading{display:none;text-align:center;padding:20px}
        .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .hidden{display:none}
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>‚ö° EVCS - Qu√©t m√£ b·∫Øt ƒë·∫ßu s·∫°c</h1>
        <div>
            <a href="home.html" style="color:#fff;text-decoration:none;margin-right:10px">Trang ch·ªß</a>
            <a href="sessions.html" style="color:#fff;text-decoration:none">L·ªãch s·ª≠</a>
        </div>
    </nav>

    <div class="container">
        <div id="message"></div>
        
        <div class="card" id="scanCard">
            <h2>B·∫Øt ƒë·∫ßu phi√™n s·∫°c</h2>
            <p>Qu√©t m√£ QR t·∫°i tr·∫°m s·∫°c ho·∫∑c d√πng ƒë·∫∑t ch·ªó ƒë·ªÉ kh·ªüi ƒë·ªông</p>
            
            <div class="scan-section">
                <div class="qr-placeholder" id="qrPlaceholder">
                    <div class="icon">üì∑</div>
                </div>
                <button class="btn btn-primary" onclick="startScan()">B·∫≠t camera qu√©t m√£</button>
                <button class="btn btn-secondary" onclick="selectFromGallery()">Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán</button>
            </div>
            
            <div class="divider"></div>
            
            <div class="input-group">
                <label>ƒê·∫∑t ch·ªó hi·ªán t·∫°i:</label>
                <div id="reservationSummary" style="text-align:left;color:#555"></div>
                <button class="btn btn-primary" id="startFromReservationBtn" onclick="startFromReservation()" disabled>B·∫Øt ƒë·∫ßu s·∫°c t·ª´ ƒë·∫∑t ch·ªó</button>
            </div>
        </div>

        <div class="card hidden" id="sessionCard">
            <h2>Th√¥ng tin phi√™n s·∫°c</h2>
            <div class="session-info" id="sessionInfo">
                <!-- Session info will be displayed here -->
            </div>
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>ƒêang kh·ªüi ƒë·ªông phi√™n s·∫°c...</p>
            </div>
            <div style="margin-top:20px">
                <button class="btn btn-primary" onclick="confirmStartSession()">X√°c nh·∫≠n b·∫Øt ƒë·∫ßu s·∫°c</button>
                <button class="btn btn-secondary" onclick="cancelSession()">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('accessToken');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let currentSession = null;
        let currentReservation = null;
        let scanStream = null;

        if (!token) {
            window.location.href = 'auth.html';
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('message');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        async function refreshAccessToken() {
            try {
                const res = await fetch(`${API_BASE}/auth/refresh`, { method: 'POST' });
                if (!res.ok) return false;
                const data = await res.json();
                if (data && data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    token = data.accessToken;
                    return true;
                }
                return false;
            } catch { return false; }
        }

        async function fetchWithAuth(url, options = {}) {
            const opts = Object.assign({}, options);
            opts.headers = Object.assign({}, opts.headers, { 'Authorization': `Bearer ${token}` });
            let res = await fetch(url, opts);
            if (res.status === 401 || res.status === 403) {
                if (await refreshAccessToken()) {
                    opts.headers['Authorization'] = `Bearer ${token}`;
                    res = await fetch(url, opts);
                } else {
                    // If refresh fails, redirect to login
                    window.location.href = 'auth.html';
                    return new Response(null, { status: 401 });
                }
            }
            return res;
        }

        // QR Code scanning functionality
        function startScan() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ camera', 'error');
                return;
            }

            const qrPlaceholder = document.getElementById('qrPlaceholder');
            qrPlaceholder.innerHTML = '<div class="spinner"></div><p>ƒêang kh·ªüi ƒë·ªông camera...</p>';

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    scanStream = stream;
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    
                    qrPlaceholder.innerHTML = '';
                    qrPlaceholder.appendChild(video);
                    
                    // Simulate QR code detection (in real app, use QR scanning library)
                    setTimeout(() => {
                        const mockSessionCode = 'SES-' + Math.floor(100000 + Math.random() * 900000);
                        showAlert(`ƒê√£ qu√©t ƒë∆∞·ª£c m√£: ${mockSessionCode}`, 'success');
                        stopScan();
                        document.getElementById('sessionCode').value = mockSessionCode;
                        startSessionByCode();
                    }, 3000);
                })
                .catch(err => {
                    showAlert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + err.message, 'error');
                    qrPlaceholder.innerHTML = '<div class="icon">üì∑</div>';
                });
        }

        function stopScan() {
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }
            const qrPlaceholder = document.getElementById('qrPlaceholder');
            qrPlaceholder.innerHTML = '<div class="icon">üì∑</div>';
        }

        function selectFromGallery() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Simulate QR code detection from image
                    const mockSessionCode = 'SES-' + Math.floor(100000 + Math.random() * 900000);
                    showAlert(`ƒê√£ ƒë·ªçc ƒë∆∞·ª£c m√£ t·ª´ ·∫£nh: ${mockSessionCode}`, 'success');
                    document.getElementById('sessionCode').value = mockSessionCode;
                    startSessionByCode();
                }
            };
            input.click();
        }

        // B·∫Øt ƒë·∫ßu phi√™n t·ª´ ƒë·∫∑t ch·ªó
        async function startFromReservation() {
            if (!currentReservation) {
                showAlert('Kh√¥ng c√≥ th√¥ng tin ƒë·∫∑t ch·ªó h·ª£p l·ªá', 'error');
                return;
            }

            try {
                showAlert('ƒêang kh·ªüi ƒë·ªông phi√™n s·∫°c t·ª´ ƒë·∫∑t ch·ªó...', 'info');
                const res = await fetchWithAuth(`${API_BASE}/sessions/start-from-reservation/${currentReservation.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehicleId: currentReservation.vehicleId || null })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ message: 'Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu phi√™n s·∫°c' }));
                    throw new Error(err.message);
                }
                const sessionData = await res.json();
                showAlert('ƒê√£ b·∫Øt ƒë·∫ßu phi√™n s·∫°c!', 'success');
                setTimeout(() => {
                    window.location.href = `charging.html?sessionId=${sessionData.id}`;
                }, 1200);
            } catch (e) {
                showAlert(e.message, 'error');
            }
        }

        function displaySessionInfo() {
            if (!currentSession) return;

            const sessionInfo = document.getElementById('sessionInfo');
            sessionInfo.innerHTML = `
                <h3>Th√¥ng tin phi√™n s·∫°c</h3>
                <div class="info-row">
                    <span>M√£ phi√™n:</span>
                    <span><strong>${currentSession.code || currentSession.id}</strong></span>
                </div>
                <div class="info-row">
                    <span>Tr·∫°m s·∫°c:</span>
                    <span>${currentSession.stationName || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span>Connector:</span>
                    <span>${currentSession.connectorType || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span>C√¥ng su·∫•t:</span>
                    <span>${currentSession.power || 'N/A'} kW</span>
                </div>
                <div class="info-row">
                    <span>Tr·∫°ng th√°i:</span>
                    <span style="color: ${getStatusColor(currentSession.status)}">${getStatusText(currentSession.status)}</span>
                </div>
                ${currentSession.reservedBy ? `
                <div class="info-row">
                    <span>ƒê√£ ƒë·∫∑t b·ªüi:</span>
                    <span>${currentSession.reservedBy}</span>
                </div>
                ` : ''}
            `;
        }

        function getStatusColor(status) {
            switch (status?.toUpperCase()) {
                case 'AVAILABLE': return '#2e7d32';
                case 'OCCUPIED': return '#f57c00';
                case 'RESERVED': return '#1565c0';
                case 'MAINTENANCE': return '#c62828';
                default: return '#666';
            }
        }

        function getStatusText(status) {
            switch (status?.toUpperCase()) {
                case 'AVAILABLE': return 'Kh·∫£ d·ª•ng';
                case 'OCCUPIED': return 'ƒêang s·ª≠ d·ª•ng';
                case 'RESERVED': return 'ƒê√£ ƒë·∫∑t';
                case 'MAINTENANCE': return 'B·∫£o tr√¨';
                default: return 'Kh√¥ng x√°c ƒë·ªãnh';
            }
        }

        async function confirmStartSession() {
            if (!currentSession) {
                showAlert('Kh√¥ng c√≥ th√¥ng tin phi√™n s·∫°c', 'error');
                return;
            }

            const loadingSection = document.getElementById('loadingSection');
            loadingSection.style.display = 'block';

            try {
                const res = await fetchWithAuth(`${API_BASE}/sessions/${currentSession.code}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!res.ok) {
                    if (res.status === 404) {
                        throw new Error('Kh√¥ng t√¨m th·∫•y phi√™n s·∫°c');
                    } else if (res.status === 403) {
                        throw new Error('B·∫°n kh√¥ng c√≥ quy·ªÅn kh·ªüi ƒë·ªông phi√™n n√†y');
                    } else if (res.status === 400) {
                        const error = await res.json().catch(() => ({ message: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá' }));
                        throw new Error(error.message || 'Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông phi√™n s·∫°c');
                    } else {
                        const error = await res.json().catch(() => ({ message: 'L·ªói server' }));
                        throw new Error(error.message || 'Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông phi√™n s·∫°c');
                    }
                }

                const sessionData = await res.json();
                showAlert('Phi√™n s·∫°c ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông th√†nh c√¥ng!', 'success');
                
                // Redirect to charging session tracking page
                setTimeout(() => {
                    window.location.href = `charging.html?sessionId=${sessionData.id}`;
                }, 2000);

            } catch (err) {
                showAlert(err.message, 'error');
                loadingSection.style.display = 'none';
            }
        }

        function cancelSession() {
            currentSession = null;
            document.getElementById('sessionCard').classList.add('hidden');
            document.getElementById('scanCard').classList.remove('hidden');
            document.getElementById('sessionCode').value = '';
            stopScan();
        }

        // Check for existing reservations when page loads
        window.addEventListener('load', async () => {
            // Check if user is logged in first
            if (!token || !user.id) {
                window.location.href = 'auth.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const reservationId = urlParams.get('reservationId');
            
            if (reservationId) {
                try {
                    const res = await fetchWithAuth(`${API_BASE}/reservations/${reservationId}`);
                    if (res.ok) {
                        const reservation = await res.json();
                        currentReservation = reservation;
                        const sumDiv = document.getElementById('reservationSummary');
                        sumDiv.innerHTML = `
                            <div><strong>M√£ ƒë·∫∑t ch·ªó:</strong> ${reservation.id}</div>
                            <div><strong>Connector:</strong> ${reservation.connectorId}</div>
                            <div><strong>Th·ªùi gian:</strong> ${reservation.startWindow || ''} ‚Üí ${reservation.endWindow || ''}</div>
                            <div id="qrImageWrap" style="margin-top:10px"></div>
                        `;
                        // Hi·ªÉn th·ªã QR cho connector
                        const qrRes = await fetchWithAuth(`${API_BASE}/sessions/reservation/${reservationId}/qr`);
                        if (qrRes.ok) {
                            const qr = await qrRes.json();
                            const img = document.createElement('img');
                            img.src = `data:image/png;base64,${qr.qr}`;
                            img.alt = 'QR phi√™n s·∫°c';
                            img.style.width = '180px';
                            img.style.height = '180px';
                            document.getElementById('qrImageWrap').appendChild(img);
                        }
                        document.getElementById('startFromReservationBtn').disabled = false;
                        showAlert('ƒê√£ t·∫£i ƒë·∫∑t ch·ªó v√† QR c·ªßa connector. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu s·∫°c.', 'success');
                    } else if (res.status === 404) {
                        showAlert('Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ch·ªó n√†y', 'warning');
                    } else {
                        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë·∫∑t ch·ªó', 'error');
                    }
                } catch (err) {
                    console.error('Error loading reservation:', err);
                    showAlert('L·ªói k·∫øt n·ªëi server', 'error');
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopScan();
        });
    </script>
</body>
</html>