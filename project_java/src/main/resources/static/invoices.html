<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVCS - Lịch sử hóa đơn</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa}
        .navbar{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center}
        .container{max-width:1100px;margin:30px auto;padding:0 20px}
        .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
        .card h2{margin-bottom:15px;color:#333}
        .filters{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s;font-size:14px}
        .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
        .btn-secondary{background:#f0f0f0;color:#666}
        .btn-secondary:hover{background:#e0e0e0}
        .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
        th{background:#f8f9ff;font-weight:600;color:#667eea}
        .badge{padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600}
        .badge.paid{background:#e8f5e9;color:#2e7d32}
        .badge.pending{background:#fff3e0;color:#f57c00}
        .badge.failed{background:#ffebee;color:#c62828}
        .badge.cancelled{background:#ffebee;color:#c62828}
        .empty{padding:15px;color:#666;text-align:center}
        .alert{padding:12px;border-radius:8px;margin-bottom:15px;text-align:center}
        .alert.error{background:#ffebee;color:#c62828}
        .alert.success{background:#e8f5e9;color:#2e7d32}
        .alert.info{background:#e3f2fd;color:#1565c0}
        .action-btn{padding:6px 12px;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;margin-right:5px}
        .btn-view{background:#667eea;color:#fff}
        .btn-download{background:#4caf50;color:#fff}
        .btn-email{background:#ff9800;color:#fff}
        .btn-view:hover,.btn-download:hover,.btn-email:hover{opacity:0.9}
        .invoice-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
        .summary-card{background:#f8f9ff;padding:15px;border-radius:8px;text-align:center}
        .summary-card h3{color:#667eea;margin-bottom:10px;font-size:16px}
        .summary-card .value{font-size:20px;font-weight:bold;color:#333}
        .summary-card .label{font-size:12px;color:#666;margin-top:5px}
        .loading{text-align:center;padding:20px}
        .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .hidden{display:none}
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>⚡ EVCS - Lịch sử hóa đơn</h1>
        <div>
            <a href="home.html" style="color:#fff;text-decoration:none;margin-right:10px">Trang chủ</a>
            <a href="sessions.html" style="color:#fff;text-decoration:none">Lịch sử sạc</a>
        </div>
    </nav>

    <div class="container">
        <div id="message"></div>
        
        <!-- Summary Cards -->
        <div class="invoice-summary">
            <div class="summary-card">
                <h3>Tổng hóa đơn</h3>
                <div class="value" id="totalInvoices">--</div>
                <div class="label">hóa đơn</div>
            </div>
            <div class="summary-card">
                <h3>Đã thanh toán</h3>
                <div class="value" id="paidInvoices">--</div>
                <div class="label">hóa đơn</div>
            </div>
            <div class="summary-card">
                <h3>Tổng tiền</h3>
                <div class="value" id="totalAmount">--</div>
                <div class="label">VNĐ</div>
            </div>
            <div class="summary-card">
                <h3>Trung bình</h3>
                <div class="value" id="avgAmount">--</div>
                <div class="label">VNĐ/hóa đơn</div>
            </div>
        </div>

        <!-- Invoice List -->
        <div class="card">
            <h2>Danh sách hóa đơn</h2>
            <div class="filters">
                <button class="btn btn-secondary" onclick="filterStatus('ALL')">Tất cả</button>
                <button class="btn btn-secondary" onclick="filterStatus('PAID')">Đã thanh toán</button>
                <button class="btn btn-secondary" onclick="filterStatus('PENDING')">Chưa thanh toán</button>
                <button class="btn btn-secondary" onclick="filterStatus('FAILED')">Thất bại</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Mã hóa đơn</th>
                        <th>Ngày</th>
                        <th>Phiên sạc</th>
                        <th>Năng lượng</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="invoicesTable">
                    <tr><td colspan="7" style="text-align:center">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('accessToken');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let invoices = [];
        let currentFilter = 'ALL';

        if (!token) {
            window.location.href = 'auth.html';
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('message');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        async function refreshAccessToken() {
            try {
                const res = await fetch(`${API_BASE}/auth/refresh`, { method: 'POST' });
                if (!res.ok) return false;
                const data = await res.json();
                if (data && data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    token = data.accessToken;
                    return true;
                }
                return false;
            } catch { return false; }
        }

        async function fetchWithAuth(url, options = {}) {
            const opts = Object.assign({}, options);
            opts.headers = Object.assign({}, opts.headers, { 'Authorization': `Bearer ${token}` });
            let res = await fetch(url, opts);
            if (res.status === 401 || res.status === 403) {
                if (await refreshAccessToken()) {
                    opts.headers['Authorization'] = `Bearer ${token}`;
                    res = await fetch(url, opts);
                } else {
                    // If refresh fails, redirect to login
                    window.location.href = 'auth.html';
                    return new Response(null, { status: 401 });
                }
            }
            return res;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(timestamp) {
            if (!timestamp) return '--';
            return new Date(timestamp).toLocaleDateString('vi-VN');
        }

        function getStatusBadge(status) {
            const normalized = (status || 'PENDING').toUpperCase() === 'ISSUED' ? 'PENDING' : (status || 'PENDING').toUpperCase();
            const statusClass = normalized.toLowerCase();
            const statusText = {
                'PAID': 'Đã thanh toán',
                'PENDING': 'Chưa thanh toán',
                'FAILED': 'Thất bại',
                'CANCELLED': 'Đã hủy'
            }[normalized] || 'Không xác định';
            
            return `<span class="badge ${statusClass}">${statusText}</span>`;
        }

        function filterStatus(status) {
            currentFilter = status;
            renderInvoices(invoices);
        }

        async function loadInvoices() {
            const tbody = document.getElementById('invoicesTable');
            
            // Check if user is logged in first
            if (!token || !user.id) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                showAlert('Đang tải danh sách hóa đơn...', 'info');
                
                const res = await fetchWithAuth(`${API_BASE}/invoices/me`);
                if (!res.ok) {
                    if (res.status === 404) {
                        // No invoices found - this is OK
                        invoices = [];
                        updateSummary();
                        renderInvoices(invoices);
                        showAlert('Bạn chưa có hóa đơn nào', 'info');
                        return;
                    } else if (res.status === 403) {
                        throw new Error('Bạn không có quyền xem hóa đơn');
                    } else {
                        throw new Error('Không thể tải danh sách hóa đơn');
                    }
                }
                
                invoices = await res.json();
                updateSummary();
                renderInvoices(invoices);
                
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#c62828">Lỗi tải dữ liệu</td></tr>';
                showAlert(err.message || 'Không thể tải danh sách hóa đơn', 'error');
            }
        }

        function updateSummary() {
            const totalInvoices = invoices.length;
            const paidInvoices = invoices.filter(inv => inv.status === 'PAID').length;
            const totalAmount = invoices.reduce((sum, inv) => sum + (inv.totalAmount || 0), 0);
            const avgAmount = totalInvoices > 0 ? totalAmount / totalInvoices : 0;

            document.getElementById('totalInvoices').textContent = totalInvoices;
            document.getElementById('paidInvoices').textContent = paidInvoices;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('avgAmount').textContent = formatCurrency(avgAmount);
        }

        function renderInvoices(items) {
            const tbody = document.getElementById('invoicesTable');
            let rows = items.map(inv => ({...inv, _status: (inv.status || 'PENDING').toUpperCase() === 'ISSUED' ? 'PENDING' : (inv.status || 'PENDING')}));
            if (currentFilter !== 'ALL') {
                rows = rows.filter(inv => inv._status === currentFilter);
            }
            
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">Không có hóa đơn nào</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map((inv, index) => `
                <tr>
                    <td><strong>${inv.invoiceNo || inv.id}</strong></td>
                    <td>${formatDate(inv.issuedAt)}</td>
                    <td>${inv.sessionCode || inv.sessionId || 'N/A'}</td>
                    <td>${inv.energyConsumed?.toFixed(2) || '0.00'} kWh</td>
                    <td><strong>${formatCurrency(inv.totalAmount || 0)}</strong></td>
                    <td>${getStatusBadge(inv.status)}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewInvoice('${inv.id}')">Xem</button>
                        <button class="action-btn btn-download" onclick="downloadInvoice('${inv.id}')">Tải</button>
                        <button class="action-btn btn-email" onclick="sendInvoiceEmail('${inv.id}')">Email</button>
                        ${inv.status === 'PENDING' ? `<button class="action-btn btn-view" onclick="payInvoice('${inv.sessionId}')">Thanh toán</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function viewInvoice(invoiceId) {
            window.location.href = `invoice.html?invoiceId=${invoiceId}`;
        }

        function payInvoice(sessionId) {
            if (!sessionId) {
                showAlert('Hóa đơn không gắn với phiên sạc', 'error');
                return;
            }
            window.location.href = `payment.html?sessionId=${sessionId}`;
        }

        async function downloadInvoice(invoiceId) {
            try {
                showAlert('Đang tải file PDF...', 'info');
                
                const pdfRes = await fetchWithAuth(`${API_BASE}/invoices/${invoiceId}/pdf`);
                if (!pdfRes.ok) throw new Error('Không thể tải file PDF');

                const blob = await pdfRes.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hoadon_${invoiceId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showAlert('Đã tải xuống file PDF thành công!', 'success');
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        async function sendInvoiceEmail(invoiceId) {
            try {
                showAlert('Đang gửi email...', 'info');
                
                const emailRes = await fetchWithAuth(`${API_BASE}/invoices/${invoiceId}/send-email`, {
                    method: 'POST'
                });

                if (!emailRes.ok) throw new Error('Không thể gửi email');

                showAlert('Đã gửi email thành công!', 'success');
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadInvoices();
        });
    </script>
</body>
</html>