<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVCS - T√¨m tr·∫°m s·∫°c</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
            position: relative;
        }
        
        .navbar h1 {
            font-size: 24px;
            cursor: pointer;
        }
        
        .btn-back {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn-back:hover {
            background: white;
            color: #667eea;
        }
        
        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: calc(100vh - 64px);
        }
        
        .sidebar {
            background: white;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .search-box {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .search-box h2 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .stations-list {
            padding: 0;
        }
        
        .station-card {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .station-card:hover {
            background: #f8f9fa;
        }
        
        .station-card.active {
            background: #e8f0fe;
            border-left: 4px solid #667eea;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .station-address {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .station-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .badge.online {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge.offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .distance {
            color: #667eea;
            font-weight: 500;
        }
        
        .map-container {
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .map-controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .map-controls button:last-child {
            margin-bottom: 0;
        }
        
        .map-controls button:hover {
            background: #5568d3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        /* Custom Leaflet popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
        }
        
        .leaflet-popup-content {
            margin: 0;
            min-width: 200px;
        }
        
        .popup-content {
            padding: 15px;
        }
        
        .popup-content h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }
        
        .popup-content p {
            margin: 4px 0;
            font-size: 13px;
            color: #666;
        }
        
        .popup-content .btn-book {
            margin-top: 12px;
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }
        
        .popup-content .btn-book:hover {
            background: #5568d3;
        }
        
        /* Custom marker colors */
        .marker-online {
            background-color: #2e7d32;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .marker-offline {
            background-color: #c62828;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .marker-user {
            background-color: #4285F4;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .map-controls {
                top: 10px;
                right: 10px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1 onclick="goHome()">‚ö° EVCS - T√¨m tr·∫°m s·∫°c</h1>
        <a href="home.html" class="btn-back">‚Üê Quay l·∫°i</a>
    </nav>
    
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="search-box">
                <h2>üîç T√¨m ki·∫øm</h2>
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput"
                    placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n tr·∫°m..."
                    oninput="searchStations()"
                />
                <div class="filters">
                    <button class="filter-btn active" onclick="filterStatus('all')">T·∫•t c·∫£</button>
                    <button class="filter-btn" onclick="filterStatus('ONLINE')">Online</button>
                    <button class="filter-btn" onclick="filterStatus('fast')">DC Fast</button>
                </div>
            </div>
            
            <div class="stations-list" id="stationsList">
                <div class="loading">ƒêang t·∫£i tr·∫°m s·∫°c...</div>
            </div>
        </div>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button onclick="getCurrentLocation()">üìç V·ªã tr√≠ c·ªßa t√¥i</button>
                <button onclick="searchNearby()">üîÑ T√¨m g·∫ßn ƒë√¢y</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('accessToken');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (!token) {
            window.location.href = 'auth.html';
        }
        
        let map;
        let markers = [];
        let stations = [];
        let currentFilter = 'all';
        let selectedStation = null;
        let userMarker = null;
        
        // Default center (Ho Chi Minh City)
        let userLocation = { lat: 10.7744, lng: 106.7019 };
        
        // Initialize map
        function initMap() {
            // Create map with OpenStreetMap tiles
            map = L.map('map').setView([userLocation.lat, userLocation.lng], 13);
            
            // Add OpenStreetMap tile layer (FREE, no API key needed!)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        
                        // Add user marker
                        const userIcon = L.divIcon({
                            className: 'marker-user',
                            iconSize: [20, 20]
                        });
                        
                        userMarker = L.marker([userLocation.lat, userLocation.lng], { 
                            icon: userIcon 
                        }).addTo(map);
                        
                        userMarker.bindPopup('<div class="popup-content"><h3>üìç V·ªã tr√≠ c·ªßa b·∫°n</h3></div>');
                        
                        loadStations();
                    },
                    () => {
                        loadStations();
                    }
                );
            } else {
                loadStations();
            }
        }
        
        async function loadStations() {
            try {
                let res = await fetch(
                    `${API_BASE}/stations/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radiusKm=20&limit=50`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (res.status === 401 || res.status === 403) {
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        res = await fetch(
                            `${API_BASE}/stations/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radiusKm=20&limit=50`,
                            { headers: { 'Authorization': `Bearer ${token}` } }
                        );
                    }
                }

                if (!res.ok) throw new Error('Failed to load stations');

                stations = await res.json();
                displayStations(stations);
                addMarkersToMap(stations);
            } catch (err) {
                document.getElementById('stationsList').innerHTML = 
                    '<div class="empty-state">Kh√¥ng th·ªÉ t·∫£i danh s√°ch tr·∫°m s·∫°c</div>';
            }
        }

        async function refreshAccessToken() {
            try {
                const res = await fetch(`${API_BASE}/auth/refresh`, { method: 'POST' });
                if (!res.ok) return false;
                const data = await res.json();
                if (data && data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    token = data.accessToken;
                    return true;
                }
                return false;
            } catch (_) {
                return false;
            }
        }
        
        function displayStations(stationsToShow) {
            const listContainer = document.getElementById('stationsList');
            
            if (!stationsToShow || stationsToShow.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">Kh√¥ng t√¨m th·∫•y tr·∫°m s·∫°c</div>';
                return;
            }
            
            listContainer.innerHTML = stationsToShow.map(station => {
                const statusClass = station.status === 'ONLINE' ? 'online' : 'offline';
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    station.lat, station.lng
                ).toFixed(1);
                
                return `
                    <div class="station-card" onclick="selectStation('${station.id}')">
                        <div class="station-name">${station.name}</div>
                        <div class="station-address">${station.address || ''}</div>
                        <div class="station-meta">
                            <span class="badge ${statusClass}">${station.status}</span>
                            <span class="distance">${distance} km</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addMarkersToMap(stationsToShow) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            stationsToShow.forEach(station => {
                const isOnline = station.status === 'ONLINE';
                
                // Custom icon
                const icon = L.divIcon({
                    className: isOnline ? 'marker-online' : 'marker-offline',
                    iconSize: [30, 30],
                    html: isOnline ? '‚ö°' : '‚ùå'
                });
                
                const marker = L.marker([station.lat, station.lng], { icon: icon })
                    .addTo(map);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    station.lat, station.lng
                ).toFixed(1);
                
                const popupContent = `
                    <div class="popup-content">
                        <h3>${station.name}</h3>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${station.address || 'N/A'}</p>
                        <p><strong>Kho·∫£ng c√°ch:</strong> ${distance} km</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge ${isOnline ? 'online' : 'offline'}">${station.status}</span></p>
                        <button class="btn-book" onclick="reserveStation('${station.id}')">üìÖ ƒê·∫∑t ch·ªó ngay</button>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', () => {
                    selectStationById(station.id);
                });
                
                markers.push(marker);
            });
        }
        
        function selectStation(stationId) {
            selectedStation = stationId;
            
            // Update UI
            document.querySelectorAll('.station-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget?.classList.add('active');
            
            // Center map on station
            const station = stations.find(s => s.id === stationId);
            if (station) {
                map.setView([station.lat, station.lng], 15);
                
                // Open popup
                const marker = markers.find(m => {
                    const pos = m.getLatLng();
                    return pos.lat === station.lat && pos.lng === station.lng;
                });
                if (marker) {
                    marker.openPopup();
                }
            }
        }
        
        function selectStationById(stationId) {
            const cards = document.querySelectorAll('.station-card');
            cards.forEach((card, index) => {
                if (stations[index]?.id === stationId) {
                    card.classList.add('active');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    card.classList.remove('active');
                }
            });
        }
        
        function reserveStation(stationId) {
            window.location.href = `reservation.html?stationId=${stationId}`;
        }
        
        function filterStatus(status) {
            currentFilter = status;
            
            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Filter stations
            let filtered = stations;
            if (status === 'ONLINE') {
                filtered = stations.filter(s => s.status === 'ONLINE');
            } else if (status === 'fast') {
                filtered = stations;
            }
            
            displayStations(filtered);
            addMarkersToMap(filtered);
        }
        
        function searchStations() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = stations.filter(s => 
                s.name.toLowerCase().includes(query) ||
                (s.address && s.address.toLowerCase().includes(query))
            );
            
            displayStations(filtered);
            addMarkersToMap(filtered);
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        
                        // Update user marker
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }
                        
                        const userIcon = L.divIcon({
                            className: 'marker-user',
                            iconSize: [20, 20]
                        });
                        
                        userMarker = L.marker([userLocation.lat, userLocation.lng], { 
                            icon: userIcon 
                        }).addTo(map);
                        
                        userMarker.bindPopup('<div class="popup-content"><h3>üìç V·ªã tr√≠ c·ªßa b·∫°n</h3></div>');
                        
                        loadStations();
                    },
                    () => {
                        alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n. Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.');
                    }
                );
            } else {
                alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation');
            }
        }
        
        function searchNearby() {
            const center = map.getCenter();
            userLocation = { lat: center.lat, lng: center.lng };
            loadStations();
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function goHome() {
            window.location.href = 'home.html';
        }
        
        // Initialize on load
        window.onload = initMap;
    </script>
</body>
</html>