<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVCS - Th√¥ng b√°o</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa}
        .navbar{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center}
        .container{max-width:1100px;margin:30px auto;padding:0 20px}
        .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
        .card h2{margin-bottom:15px;color:#333}
        .toolbar{display:flex;gap:10px;margin-bottom:10px;align-items:center}
        .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
        .btn-secondary{background:#f0f0f0;color:#666}
        .toggle{display:flex;gap:6px;align-items:center}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
        tr.clickable{cursor:pointer}
        .badge{padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600}
        .badge.unread{background:#fff3e0;color:#f57c00}
        .badge.read{background:#e8f5e9;color:#2e7d32}
        .pagination{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
        .split{display:grid;grid-template-columns:2fr 1fr;gap:20px}
        .detail{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
        .detail h3{margin-bottom:8px}
        .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px}
        .alert{padding:12px;border-radius:8px;margin-bottom:15px}
        .alert.error{background:#ffebee;color:#c62828}
        .hidden{display:none}
        .meta{font-family:ui-monospace,Consolas,monospace;font-size:12px;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:10px;white-space:pre-wrap}
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üîî EVCS - Th√¥ng b√°o</h1>
        <div>
            <a href="home.html" style="color:#fff;text-decoration:none;margin-right:10px">Trang ch·ªß</a>
            <a href="stations.html" style="color:#fff;text-decoration:none">T√¨m tr·∫°m</a>
        </div>
    </nav>

    <div class="container">
        <div id="message"></div>

        <div class="split">
            <div class="card">
                <h2>Danh s√°ch th√¥ng b√°o</h2>
                <div class="toolbar">
                    <button class="btn btn-secondary" onclick="reload()">T·∫£i l·∫°i</button>
                    <button class="btn btn-primary" onclick="markAllRead()">ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</button>
                    <div class="toggle">
                        <input type="checkbox" id="onlyUnread" onchange="applyFilter()">
                        <label for="onlyUnread">Ch·ªâ hi·ªÉn th·ªã ch∆∞a ƒë·ªçc</label>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>Lo·∫°i</th>
                            <th>K√™nh</th>
                            <th>T·∫°o l√∫c</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="notifTable"><tr><td colspan="5">ƒêang t·∫£i...</td></tr></tbody>
                </table>
                <div class="pagination">
                    <button class="btn btn-secondary" onclick="prevPage()">Tr∆∞·ªõc</button>
                    <div id="pageInfo" style="align-self:center"></div>
                    <button class="btn btn-secondary" onclick="nextPage()">Sau</button>
                </div>
            </div>

            <div id="detailCard" class="detail hidden">
                <h3 id="dTitle"></h3>
                <div class="kv"><div>Lo·∫°i</div><div id="dType"></div></div>
                <div class="kv"><div>K√™nh</div><div id="dChannel"></div></div>
                <div class="kv"><div>Tr·∫°ng th√°i</div><div id="dStatus"></div></div>
                <div class="kv"><div>T·∫°o l√∫c</div><div id="dCreated"></div></div>
                <div class="kv"><div>ƒê·ªçc l√∫c</div><div id="dReadAt"></div></div>
                <div style="margin-top:12px;font-weight:600">N·ªôi dung</div>
                <div id="dMessage" style="margin-top:6px"></div>
                <div style="margin-top:12px;font-weight:600">Metadata</div>
                <div id="dMeta" class="meta"></div>
                <div style="margin-top:12px">
                    <button id="btnMarkRead" class="btn btn-primary" onclick="markSelectedRead()">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('accessToken');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!token) { window.location.href = 'auth.html'; }
        let state = { page:0, size:10, content:[], totalPages:0, totalElements:0 };
        let selected = null;

        function showMsg(text, type='error') {
            const m = document.getElementById('message');
            m.className = 'alert ' + type;
            m.textContent = text;
            setTimeout(()=>{ m.className=''; m.textContent=''; }, 4000);
        }

        async function refreshAccessToken() {
            try {
                const res = await fetch(`${API_BASE}/auth/refresh`, { method: 'POST' });
                if (!res.ok) return false;
                const data = await res.json();
                if (data && data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    token = data.accessToken;
                    return true;
                }
                return false;
            } catch { return false; }
        }

        async function fetchWithAuth(url, options={}) {
            const opts = Object.assign({}, options);
            opts.headers = Object.assign({}, opts.headers, { 'Authorization': `Bearer ${token}` });
            let res = await fetch(url, opts);
            if (res.status === 401 || res.status === 403) {
                if (await refreshAccessToken()) {
                    opts.headers['Authorization'] = `Bearer ${token}`;
                    res = await fetch(url, opts);
                }
            }
            return res;
        }

        function fmt(dt) {
            if (!dt) return '';
            const d = new Date(dt);
            return d.toLocaleString('vi-VN', { hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'numeric' });
        }

        function reload() { loadPage(state.page); }
        function prevPage() { if (state.page>0) loadPage(state.page-1); }
        function nextPage() { if (state.page+1 < state.totalPages) loadPage(state.page+1); }

        async function loadPage(page=0) {
            const tbody = document.getElementById('notifTable');
            try {
                const res = await fetchWithAuth(`${API_BASE}/notifications?page=${page}&size=${state.size}`);
                if (!res.ok) throw new Error('Load notifications failed');
                const data = await res.json();
                state.page = data.number || 0;
                state.size = data.size || state.size;
                state.totalPages = data.totalPages || 0;
                state.totalElements = data.totalElements || 0;
                state.content = data.content || [];
                renderTable();
            } catch { tbody.innerHTML = '<tr><td colspan="5">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>'; }
        }

        function applyFilter() { renderTable(); }

        function renderTable() {
            const tbody = document.getElementById('notifTable');
            const onlyUnread = document.getElementById('onlyUnread').checked;
            let rows = state.content;
            if (onlyUnread) rows = rows.filter(n => !n.read);
            if (!rows.length) { tbody.innerHTML = '<tr><td colspan="5">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; } else {
                tbody.innerHTML = rows.map(n => `
                    <tr class="clickable" onclick="openDetail(${n.id})">
                        <td>${n.title||''}</td>
                        <td>${n.type||''}</td>
                        <td>${n.channel||''}</td>
                        <td>${fmt(n.createdAt)}</td>
                        <td>${n.read ? '<span class="badge read">ƒê√£ ƒë·ªçc</span>' : '<span class="badge unread">Ch∆∞a ƒë·ªçc</span>'}</td>
                    </tr>
                `).join('');
            }
            document.getElementById('pageInfo').textContent = `Trang ${state.page+1}/${state.totalPages || 1}`;
        }

        function openDetail(id) {
            const n = state.content.find(x => x.id === id);
            if (!n) return;
            selected = n;
            document.getElementById('detailCard').classList.remove('hidden');
            document.getElementById('dTitle').textContent = n.title||'';
            document.getElementById('dType').textContent = n.type||'';
            document.getElementById('dChannel').textContent = n.channel||'';
            document.getElementById('dStatus').textContent = n.read ? 'ƒê√£ ƒë·ªçc' : 'Ch∆∞a ƒë·ªçc';
            document.getElementById('dCreated').textContent = fmt(n.createdAt);
            document.getElementById('dReadAt').textContent = fmt(n.readAt);
            document.getElementById('dMessage').textContent = n.message||'';
            let metaText = n.metadata || '';
            try { if (metaText) metaText = JSON.stringify(JSON.parse(metaText), null, 2); } catch {}
            document.getElementById('dMeta').textContent = metaText || '(kh√¥ng c√≥)';
            document.getElementById('btnMarkRead').disabled = !!n.read;
        }

        async function markSelectedRead() {
            if (!selected) return;
            try {
                const res = await fetchWithAuth(`${API_BASE}/notifications/${selected.id}/read`, { method:'POST' });
                if (!res.ok) throw new Error('ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc th·∫•t b·∫°i');
                showMsg('ƒê√£ ƒë√°nh d·∫•u th√¥ng b√°o l√† ƒë√£ ƒë·ªçc','success');
                loadPage(state.page);
            } catch(err) { showMsg(err.message); }
        }

        async function markAllRead() {
            try {
                const res = await fetchWithAuth(`${API_BASE}/notifications/read-all`, { method:'POST' });
                if (!res.ok) throw new Error('ƒê√°nh d·∫•u t·∫•t c·∫£ th·∫•t b·∫°i');
                showMsg('ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o l√† ƒë√£ ƒë·ªçc','success');
                loadPage(state.page);
            } catch(err) { showMsg(err.message); }
        }

        loadPage(0);
    </script>
</body>
</html>